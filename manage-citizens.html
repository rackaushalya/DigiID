<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Manage Citizens</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="assets/images/logo/gov-logo.jpg" alt="Government Logo" class="me-2" style="height: 40px;">
        <span class="fw-bold">eCitizen ID</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="bi bi-house-door"></i> Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="manage-citizens.html">
              <i class="bi bi-people-fill"></i> Manage Citizens
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MANAGE CITIZENS HEADER -->
  <section class="bg-primary bg-gradient text-white py-5">
    <div class="container text-center">
      <div class="d-inline-flex align-items-center justify-content-center mb-3"
        style="width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,0.15);">
        <i class="bi bi-person-vcard fs-1"></i>
      </div>

      <h1 class="fw-bold mb-2">Citizen Digital ID</h1>

      <p class="lead mb-0 opacity-75">
        Manage citizen records securely — add new citizens, update existing details,
        and remove outdated records from the national database.
      </p>
    </div>
  </section>


  <div class="container my-4">

    <div class="row g-3">
      <div class="col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Citizen Form</h5>

            <div id="msg" class="alert d-none" role="alert"></div>

            <form id="citizenForm" autocomplete="on">
              <input type="hidden" id="editMode" value="false">
              <input type="hidden" id="originalNdi" value="">
              <input type="hidden" id="mongoId" value="">

              <div class="mb-2">
                <label class="form-label">NDI ID</label>
                <input class="form-control" id="NDI_ID" required>
              </div>

              <div class="mb-2">
                <label class="form-label">First Name</label>
                <input class="form-control" id="FirstName" required>
              </div>

              <div class="mb-2">
                <label class="form-label">Last Name</label>
                <input class="form-control" id="LastName" required>
              </div>

              <div class="mb-2">
                <label class="form-label">Date of Birth (DD-MM-YYYY)</label>
                <input class="form-control" id="DoB" type="text" inputmode="numeric" placeholder="20-11-2000"
                  pattern="^\d{2}-\d{2}-\d{4}$" title="Enter DOB in DD-MM-YYYY format (e.g., 20-11-2000)" required>
                <div class="form-text">Format: <b>DD-MM-YYYY</b> (Example: 20-11-2000)</div>
              </div>

              <div class="mb-2">
                <label class="form-label">Email</label>
                <input class="form-control" id="Email" type="email" required>
              </div>

              <div class="mb-2">
                <label class="form-label">Phone</label>
                <input class="form-control" id="Phone" placeholder="+9477xxxxxxx" required>
              </div>

              <div class="mb-2">
                <label class="form-label">Occupation (comma separated)</label>
                <input class="form-control" id="Occupation" placeholder="Software Engineer, SCU">
              </div>

              <div class="mb-2">
                <label class="form-label">Nationality</label>
                <input class="form-control" id="Nationality" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Blood Group</label>
                <input class="form-control" id="Blood_Group" placeholder="A+" required>
              </div>

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" id="saveBtn">Save Citizen</button>
                <button type="button" class="btn btn-secondary" id="clearBtn">Clear</button>
                <button type="button" class="btn btn-outline-danger d-none" id="cancelEditBtn">Cancel Edit</button>
              </div>
            </form>

          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">

            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">Citizens</h5>
              <button class="btn btn-outline-primary btn-sm" id="refreshBtn">Refresh</button>
            </div>
            <div class="input-group input-group-sm mb-3">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="searchNdiInput" placeholder="Search by NDI ID (e.g., NDI001)">
              <button class="btn btn-primary" id="searchNdiBtn" type="button">Search</button>
              <button class="btn btn-outline-secondary" id="clearSearchBtn" type="button">Clear</button>
            </div>


            <div class="table-responsive">
              <table class="table table-striped align-middle">
                <thead>
                  <tr>
                    <th>NDI</th>
                    <th>Name</th>
                    <th>DoB</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th style="width:160px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="citizenTableBody">
                  <!-- rows here -->
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- <script src="assets/js/citizens.js">
  
</script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ==========================
    // CONFIG (change if needed)
    // ==========================
    const API_BASE = "http://localhost:3000"; // your node server

    // ==========================
    // HELPERS
    // ==========================
    function showMsg(text, type = "success") {
      const msg = $("#msg");
      msg.removeClass("d-none alert-success alert-danger alert-warning alert-info")
        .addClass("alert-" + type)
        .text(text);
      setTimeout(() => msg.addClass("d-none"), 2500);
    }

    function normalizeDob(input) {
      const v = (input || "").trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
        const [y, m, d] = v.split("-");
        return `${d}-${m}-${y}`;
      }
      return v;
    }


    function getFormData() {
      return {
        nic: $("#NDI_ID").val().trim(),              // map NDI -> nic in backend
        fullName: ($("#FirstName").val().trim() + " " + $("#LastName").val().trim()).trim(),
        firstName: $("#FirstName").val().trim(),
        lastName: $("#LastName").val().trim(),
        dob: normalizeDob($("#DoB").val()),
        email: $("#Email").val().trim(),
        phone: $("#Phone").val().trim(),
        occupation: $("#Occupation").val().trim(),   // optional
        nationality: $("#Nationality").val().trim(),
        bloodGroup: $("#Blood_Group").val().trim()
      };
    }

    function clearForm() {
      $("#citizenForm")[0].reset();
      $("#editMode").val("false");
      $("#originalNdi").val("");
      + $("#mongoId").val("");
      $("#cancelEditBtn").addClass("d-none");
      $("#saveBtn").text("Save Citizen");
    }


    function renderTable(list) {
      const tbody = $("#citizenTableBody");
      tbody.empty();

      if (!list || list.length === 0) {
        tbody.append(`<tr><td colspan="6" class="text-center text-muted">No citizens found</td></tr>`);
        return;
      }

      list.forEach(c => {
        const ndi = c.nic || c.NDI_ID || c.ndi || "-";
        const name = c.fullName || (c.firstName ? (c.firstName + " " + (c.lastName || "")) : "-");
        const dob = c.dob || c.DoB || "-";
        const email = c.email || "-";
        const phone = c.phone || "-";

        tbody.append(`
      <tr>
        <td>${ndi}</td>
        <td>${name}</td>
        <td>${dob}</td>
        <td>${email}</td>
        <td>${phone}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1 btn-edit"
                  data-id="${c._id || ""}" data-ndi="${ndi}">
            Edit
          </button>
          <button class="btn btn-sm btn-outline-danger btn-delete"
                  data-id="${c._id || ""}" ${c._id ? "" : "disabled"}>
            Delete
          </button>
        </td>
      </tr>
    `);
      });
    }


    // ==========================
    // AJAX FUNCTIONS
    // ==========================

    // GET ALL citizens
    function loadCitizens() {
      $.ajax({
        url: `${API_BASE}/citizens`,
        method: "GET",
        success: function (res) {
          // res format from backend: { ok:true, data:[...] }
          renderTable(res.data || []);
        },
        error: function (xhr) {
          console.error(xhr.responseText);
          showMsg("Failed to load citizens", "danger");
        }
      });
    }

    // SEARCH ONE citizen by NDI (POST /citizens/findOne)
    function searchCitizenByNdi(ndi) {
      $.ajax({
        url: `${API_BASE}/citizens/findOne`,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ nic: ndi }), // backend searches first provided field
        success: function (res) {
          const c = res.data;
          if (!c) return showMsg("Citizen not found", "warning");

          // Fill form
          $("#NDI_ID").val(c.nic || "");
          $("#FirstName").val(c.firstName || (c.fullName ? c.fullName.split(" ")[0] : ""));
          $("#LastName").val(c.lastName || (c.fullName ? c.fullName.split(" ").slice(1).join(" ") : ""));
          $("#DoB").val(c.dob || "");
          $("#Email").val(c.email || "");
          $("#Phone").val(c.phone || "");
          $("#Occupation").val(c.occupation || "");
          $("#Nationality").val(c.nationality || "");
          $("#Blood_Group").val(c.bloodGroup || "");

          showMsg("Citizen loaded to form", "success");
        },
        error: function (xhr) {
          console.error(xhr.responseText);
          showMsg("Citizen not found", "warning");
        }
      });
    }

    // REGISTER citizen (POST /citizens)
    function registerCitizen() {
      const payload = getFormData();

      $.ajax({
        url: `${API_BASE}/citizens`,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function (res) {
          showMsg("Citizen saved successfully ✅", "success");
          clearForm();
          loadCitizens();
        },
        error: function (xhr) {
          console.error(xhr.responseText);
          const msg = (xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : "Save failed";
          showMsg(msg, "danger");
        }
      });
    }

    // OPTIONAL: delete by Mongo _id (only if your backend has DELETE /citizens/:id)
    function deleteCitizenById(id) {
      $.ajax({
        url: `${API_BASE}/citizens/${id}`,
        method: "DELETE",
        success: function () {
          showMsg("Citizen deleted", "success");
          loadCitizens();
        },
        error: function (xhr) {
          console.error(xhr.responseText);
          showMsg("Delete failed (backend route missing?)", "danger");
        }
      });
    }

    // ==========================
    // EVENTS
    // ==========================
    $(document).ready(function () {

      // Auto load table when page opens
      loadCitizens();
      // ✅ If redirected from search.html, auto-load + enter edit mode
      const params = new URLSearchParams(window.location.search);
      const nicFromUrl = (params.get("nic") || "").trim();
      const editFromUrl = params.get("edit") === "1";

      if (nicFromUrl) {
        $.ajax({
          url: `${API_BASE}/citizens/findOne`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ nic: nicFromUrl }),
          success: function (res) {
            if (!res.data) return showMsg("Citizen not found", "warning");
            // enterEditMode already exists in your file :contentReference[oaicite:6]{index=6}
            if (editFromUrl) enterEditMode(res.data);
            else {
              // even if not edit=1, still load it to the form
              enterEditMode(res.data);
            }
            showMsg("Citizen loaded from Search page", "info");
          },
          error: function () {
            showMsg("Citizen not found", "warning");
          }
        });
      }


      // Refresh button
      $("#refreshBtn").on("click", function () {
        loadCitizens();
      });

      // Save citizen (register)
      $("#citizenForm").on("submit", function (e) {
        e.preventDefault();

        const isEdit = $("#editMode").val() === "true";
        if (isEdit) updateCitizen();
        else registerCitizen();
      });


      // Clear button
      $("#clearBtn").on("click", function () {
        clearForm();
        showMsg("Cleared", "info");
      });

      // Click search button in table row (loads citizen into form)
      $(document).on("click", ".btn-search-one", function () {
        const ndi = $(this).data("ndi");
        if (!ndi) return showMsg("NDI not found in row", "warning");
        searchCitizenByNdi(ndi);
      });

      // Delete button (only works if your backend has DELETE route)
      $(document).on("click", ".btn-delete", function () {
        const id = $(this).data("id");
        if (!id) return showMsg("Missing Mongo _id (cannot delete)", "warning");
        if (confirm("Delete this citizen?")) {
          deleteCitizenById(id);
        }
      });





      // Search bar button
      $("#searchNdiBtn").on("click", function () {
        const ndi = $("#searchNdiInput").val().trim();
        if (!ndi) return showMsg("Enter NDI ID to search", "warning");

        // Search and show only that result in table
        $.ajax({
          url: `${API_BASE}/citizens/findOne`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ nic: ndi }),
          success: function (res) {
            if (!res.data) return showMsg("Citizen not found", "warning");
            renderTable([res.data]);        // show single row
            showMsg("Search result loaded", "success");
          },
          error: function () {
            showMsg("Citizen not found", "warning");
          }
        });
      });

      // Enter key triggers search
      $("#searchNdiInput").on("keypress", function (e) {
        if (e.which === 13) {
          e.preventDefault();
          $("#searchNdiBtn").click();
        }
      });

      // Clear search
      $("#clearSearchBtn").on("click", function () {
        $("#searchNdiInput").val("");
        loadCitizens();
      });

      // Edit button click
      $(document).on("click", ".btn-edit", function () {
        const ndi = $(this).data("ndi");
        if (!ndi) return showMsg("Missing NDI in row", "warning");

        $.ajax({
          url: `${API_BASE}/citizens/findOne`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ nic: ndi }),
          success: function (res) {
            if (!res.data) return showMsg("Citizen not found", "warning");
            enterEditMode(res.data);
            showMsg("Edit mode enabled", "info");
          },
          error: function () {
            showMsg("Citizen not found", "warning");
          }
        });
      });


      // Cancel edit
      $("#cancelEditBtn").on("click", function () {
        clearForm();
        showMsg("Edit canceled", "info");
      });


    });




    function enterEditMode(c) {
      // Fill form
      $("#NDI_ID").val(c.nic || "");
      $("#FirstName").val(c.firstName || (c.fullName ? c.fullName.split(" ")[0] : ""));
      $("#LastName").val(c.lastName || (c.fullName ? c.fullName.split(" ").slice(1).join(" ") : ""));
      $("#DoB").val(c.dob || "");
      $("#Email").val(c.email || "");
      $("#Phone").val(c.phone || "");
      $("#Occupation").val(c.occupation || "");
      $("#Nationality").val(c.nationality || "");
      $("#Blood_Group").val(c.bloodGroup || "");

      // Edit state
      $("#editMode").val("true");
      $("#originalNdi").val(c.nic || "");
      $("#mongoId").val(c._id || "");

      $("#cancelEditBtn").removeClass("d-none");
      $("#saveBtn").text("Update Citizen");
    }

    function updateCitizen() {
      const id = $("#mongoId").val().trim();
      if (!id) {
        showMsg("Cannot update: missing Mongo _id. Click Edit from table first.", "danger");
        return;
      }

      const payload = getFormData();

      $.ajax({
        url: `${API_BASE}/citizens/${id}`,   // ✅ requires backend PUT route
        method: "PUT",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function () {
          showMsg("Citizen updated ✅", "success");
          clearForm();
          loadCitizens();
        },
        error: function (xhr) {
          console.error(xhr.responseText);
          const msg = (xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : "Update failed";
          showMsg(msg, "danger");
        }
      });
    }

  </script>

</body>

</html>