<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Citizens</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>

    <!-- NAVBAR (same style as index/manage-citizens) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="assets/images/logo/gov-logo.jpg" alt="Government Logo" class="me-2" style="height: 40px;">
                <span class="fw-bold">eCitizen ID</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="manage-citizens.html"><i class="bi bi-people-fill"></i> Manage
                            Citizens</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="search.html"><i class="bi bi-search"></i> Search</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <section class="py-5 bg-light">
        <div class="container">
            <div class="row align-items-center mb-4">
                <div class="col-md-8">
                    <h1 class="fw-bold mb-1">Search Citizens</h1>
                    <p class="lead mb-0">Lookup citizen records by NDI, name, date of birth, email, phone or occupation.
                        UI-only (no backend).</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <a href="manage-citizens.html" class="btn btn-primary"><i class="bi bi-people-fill"></i> Manage
                        Citizens</a>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form id="searchForm" class="row g-2 align-items-center">
                        <div class="col-sm-4">
                            <label class="form-label small mb-1">Search Field</label>
                            <select id="searchField" class="form-select">
                                <option value="nic">NDI ID</option>
                                <option value="firstName">First Name</option>
                                <option value="lastName">Last Name</option>
                                <option value="dob">Date of Birth</option>
                                <option value="email">Email</option>
                                <option value="phone">Phone</option>
                                <option value="occupation">Occupation</option>
                            </select>
                        </div>

                        <div class="col-sm-5" id="textInputWrap">
                            <label class="form-label small mb-1">Query</label>
                            <input id="searchInput" class="form-control" placeholder="Enter search term">
                        </div>

                        <div class="col-sm-3 d-flex gap-2 align-items-end">
                            <button type="button" id="searchBtn" class="btn btn-primary w-100">Search</button>
                            <button type="button" id="clearBtn" class="btn btn-outline-secondary w-100">Clear</button>
                        </div>

                        <div class="col-12 mt-2">
                            <small class="text-muted">Tip: choose the correct field type first (e.g. Date of Birth uses
                                a date input).</small>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="card-title mb-0">Search Results</h5>
                        <div>
                            <span class="badge bg-secondary" id="resultCount">0 results</span>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>NDI</th>
                                    <th>Name</th>
                                    <th>DoB</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Occupation</th>
                                    <th style="width:140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No results. Use the search above
                                        (UI-only).</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <footer class="py-3 bg-primary text-white text-center">
        <small>&copy; 2025 eCitizen ID. All rights reserved.</small>
    </footer>

    <!-- JS (small client-side UI behaviour only) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "http://localhost:3000";

        // ==========================
        // DOB helpers
        // ==========================
        function normalizeDob(input) {
            const v = (input || "").trim();

            // If user picked a browser date value: YYYY-MM-DD -> DD-MM-YYYY
            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                const [y, m, d] = v.split("-");
                return `${d}-${m}-${y}`;
            }

            // Already DD-MM-YYYY
            if (/^\d{2}-\d{2}-\d{4}$/.test(v)) return v;

            return v; // leave as-is
        }

        function includesSafe(hay, needle) {
            return String(hay || "").toLowerCase().includes(String(needle || "").toLowerCase());
        }

        // ==========================
        // UI: input type per field
        // ==========================
        function setInputForField(field) {
            const wrap = document.getElementById("textInputWrap");
            wrap.innerHTML = "";

            const label = document.createElement("label");
            label.className = "form-label small mb-1";
            label.innerText = "Query";

            // ✅ Make DoB a normal text field (not date picker)
            if (field === "dob") {
                const input = document.createElement("input");
                input.type = "text";
                input.id = "searchInput";
                input.className = "form-control";
                input.placeholder = "DD-MM-YYYY (e.g., 20-11-2000) or YYYY-MM-DD";
                wrap.appendChild(label);
                wrap.appendChild(input);
                return;
            }

            if (field === "email") {
                const input = document.createElement("input");
                input.type = "email";
                input.id = "searchInput";
                input.className = "form-control";
                input.placeholder = "Enter email address";
                wrap.appendChild(label);
                wrap.appendChild(input);
                return;
            }

            if (field === "phone") {
                const input = document.createElement("input");
                input.type = "tel";
                input.id = "searchInput";
                input.className = "form-control";
                input.placeholder = "+9477xxxxxxx";
                wrap.appendChild(label);
                wrap.appendChild(input);
                return;
            }

            // default: text input
            const input = document.createElement("input");
            input.type = "text";
            input.id = "searchInput";
            input.className = "form-control";
            input.placeholder = "Enter search term";
            wrap.appendChild(label);
            wrap.appendChild(input);
        }

        // ==========================
        // render results
        // ==========================
        function renderRows(list) {
            const body = document.getElementById("resultsBody");
            const count = document.getElementById("resultCount");

            body.innerHTML = "";

            if (!list || list.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No results found.</td></tr>';
                count.innerText = "0 results";
                return;
            }

            list.forEach((c) => {
                const ndi = c.nic || "-";
                const name = c.fullName || ((c.firstName || "") + " " + (c.lastName || "")).trim() || "-";
                const dob = c.dob || "-";
                const email = c.email || "-";
                const phone = c.phone || "-";
                const occupation = c.occupation || "-";

                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>${ndi}</td>
        <td>${name}</td>
        <td>${dob}</td>
        <td>${email}</td>
        <td>${phone}</td>
        <td>${occupation}</td>
        <td>
          <a href="manage-citizens.html?nic=${encodeURIComponent(ndi)}&edit=1"
             class="btn btn-sm btn-outline-secondary">
             Edit
          </a>
        </td>
      `;
                body.appendChild(tr);
            });

            count.innerText = `${list.length} result${list.length === 1 ? "" : "s"}`;
        }

        // ==========================
        // Search actions
        // ==========================
        function searchNow() {
            const field = document.getElementById("searchField").value;
            const rawValue = ((document.getElementById("searchInput") || {}).value || "").trim();

            const body = document.getElementById("resultsBody");
            const count = document.getElementById("resultCount");

            body.innerHTML = "";
            count.innerText = "0 results";

            if (!rawValue) {
                body.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Please enter a search term.</td></tr>';
                return;
            }

            // ✅ If searching by NDI: use POST /citizens/findOne (fast + exact)
            if (field === "nic") {
                $.ajax({
                    url: `${API_BASE}/citizens/findOne`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ nic: rawValue }),
                    success: function (res) {
                        const citizen = res.data ? [res.data] : [];
                        renderRows(citizen);
                    },
                    error: function () {
                        renderRows([]);
                    },
                });
                return;
            }

            // ✅ Otherwise: get all and filter client-side
            $.ajax({
                url: `${API_BASE}/citizens`,
                method: "GET",
                success: function (res) {
                    const list = res.data || [];
                    const q = field === "dob" ? normalizeDob(rawValue) : rawValue;

                    const filtered = list.filter((c) => {
                        const val =
                            field === "dob" ? normalizeDob(c.dob) :
                                field === "firstName" ? c.firstName :
                                    field === "lastName" ? c.lastName :
                                        field === "email" ? c.email :
                                            field === "phone" ? c.phone :
                                                field === "occupation" ? c.occupation :
                                                    "";

                        return includesSafe(val, q);
                    });

                    renderRows(filtered);
                },
                error: function () {
                    renderRows([]);
                },
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const fieldSelect = document.getElementById("searchField");
            setInputForField(fieldSelect.value);

            fieldSelect.addEventListener("change", function () {
                setInputForField(this.value);
            });

            document.getElementById("searchBtn").addEventListener("click", searchNow);

            // Enter key triggers search
            document.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    const active = document.activeElement;
                    if (active && active.id === "searchInput") {
                        e.preventDefault();
                        searchNow();
                    }
                }
            });

            document.getElementById("clearBtn").addEventListener("click", function () {
                setInputForField(document.getElementById("searchField").value);
                document.getElementById("resultsBody").innerHTML =
                    '<tr><td colspan="7" class="text-center text-muted">No results. Use the search above.</td></tr>';
                document.getElementById("resultCount").innerText = "0 results";
            });
        });
    </script>



</body>

</html>